# Detalhamento das Medições e Alarmes para o Medidor Trifásico com CS5463

Com base na análise do datasheet do CS5463 (DS678F4, Cirrus Logic) e nos requisitos do projeto, o sistema de medição trifásico implementado com três CIs CS5463 e um microcontrolador ESP32 fornecerá um conjunto abrangente de medições elétricas e funcionalidades de alarme para cada uma das três fases monitoradas.

## Medições Elétricas por Fase

Cada chip CS5463, dedicado a uma fase específica, será configurado para adquirir e calcular continuamente os seguintes parâmetros:

*   **Tensão e Corrente Instantâneas (V, I):** Leituras amostradas em alta frequência pelos ADCs internos, representando os valores momentâneos da forma de onda de tensão e corrente. Embora úteis para análises detalhadas da forma de onda, geralmente não são o foco principal para monitoramento contínuo, mas servem de base para outros cálculos.
*   **Tensão RMS (VRMS) e Corrente RMS (IRMS):** Valores eficazes calculados sobre um número configurável de ciclos da rede (N), fornecendo a magnitude real da tensão e corrente na fase. São fundamentais para a maioria das aplicações de monitoramento e faturamento.
*   **Potência Ativa (PActive ou P):** Também conhecida como potência real, representa a energia efetivamente consumida pela carga. É calculada pela média do produto da tensão e corrente instantâneas ao longo do ciclo de cálculo (N amostras). É a base para a medição de consumo de energia (kWh).
*   **Potência Aparente (S):** Calculada como o produto dos valores VRMS e IRMS (S = VRMS * IRMS). Representa a potência total que a fonte deve fornecer, incluindo as parcelas ativa e reativa. É medida em Volt-Ampere (VA).
*   **Potência Reativa (Q):** O CS5463 oferece duas formas de cálculo para a potência reativa. Uma (QTrig) é calculada trigonometricamente a partir da potência ativa e aparente (Q = sqrt(S² - P²)). A outra (QAvg) é calculada pela média do produto da corrente instantânea pela tensão instantânea defasada de 90 graus (obtida por um filtro interno). Ambas representam a potência que oscila entre a fonte e a carga devido a elementos reativos (indutores, capacitores) e é medida em Volt-Ampere reativo (VAR).
*   **Fator de Potência (PF):** Indica a eficiência com que a energia é utilizada pela carga. É calculado como a razão entre a potência ativa e a potência aparente (PF = P / S). O CS5463 fornece o valor e o sinal (indicando se a carga é predominantemente indutiva ou capacitiva, baseado no sinal da potência ativa).
*   **Frequência da Linha:** Embora o CS5463 não possua um registrador direto para a frequência, ela pode ser calculada com precisão pelo microcontrolador ESP32. Uma abordagem comum é usar o próprio CS5463 para detectar os cruzamentos por zero da tensão (utilizando interrupções ou polling do bit de sinal da tensão) ou analisar a duração de um número inteiro de ciclos da rede, relacionando-a com o clock do sistema e o número de amostras (N) configurado no registrador Cycle Count.
*   **Potência Ativa Fundamental (PFundamental) e Reativa Fundamental (QFundamental):** O CI pode calcular a parcela da potência ativa e reativa correspondente apenas à frequência fundamental da rede (50Hz ou 60Hz), utilizando uma transformada discreta de Fourier (DFT) interna. Isso é útil para análises de qualidade de energia.
*   **Potência Ativa Harmônica (PHarmonic):** Calculada pela diferença entre a potência ativa total (PActive) e a potência ativa fundamental (PFundamental). Indica a potência associada às componentes harmônicas presentes na rede.
*   **Picos de Tensão e Corrente (Vpeak, Ipeak):** O CS5463 registra os valores máximos (em magnitude) de tensão e corrente instantâneas detectados durante o último ciclo de cálculo. Útil para identificar surtos ou picos de corrente de partida.
*   **Temperatura Interna (T):** O sensor de temperatura on-chip pode ser lido para monitorar a temperatura de operação do CI ou para implementar compensações térmicas, se necessário.

## Alarmes e Eventos por Fase

O sistema implementará os seguintes alarmes, utilizando as funcionalidades do CS5463 e lógica adicional no ESP32:

*   **Alarme de Tensão Fora da Faixa (Subtensão/Sobretensão):** O usuário especificou a faixa normal como 105V a 135V. O CS5463 possui uma funcionalidade de detecção de afundamento de tensão (Voltage Sag) configurável através dos registradores `VSagLevel` e `VSagDuration` (Página 3). O ESP32 monitorará o valor VRMS de cada fase. Se VRMS cair abaixo de 105V ou exceder 135V por um período configurável (para evitar alarmes espúrios por transientes curtos), um alarme será gerado para a fase correspondente. A funcionalidade de Sag Detect do CS5463 pode ser usada como um gatilho rápido para subtensão, complementado pela verificação contínua do VRMS pelo ESP32 para a faixa completa.
*   **Alarme de Corrente Alta (Sobrecarga):** O limite especificado é > 70A. Similarmente à detecção de subtensão, o CS5463 possui detecção de falha de corrente (Current Fault) configurável pelos registradores `IFaultLevel` e `IFaultDuration` (Página 3). O ESP32 monitorará o valor IRMS de cada fase. Se IRMS exceder 70A por um período configurável, um alarme de sobrecorrente será gerado para a fase afetada. A funcionalidade de Fault Detect do CS5463 pode atuar como um gatilho rápido.
*   **Alarme de Falta de Fase:** Este alarme será implementado logicamente pelo ESP32. Ele monitorará continuamente o VRMS de cada uma das três fases. Se o VRMS de uma fase cair abaixo de um limiar significativamente baixo (por exemplo, < 50V, a ser definido como parâmetro), indicando uma ausência quase completa de tensão naquela fase, um alarme de "Falta de Fase" será gerado para a fase específica. Isso diferencia uma falta completa de uma simples subtensão.

Todas as medições e status de alarme de cada fase serão agregados pelo ESP32 e formatados em mensagens JSON distintas para cada fase, sendo então publicados nos respectivos tópicos MQTT configurados.
